<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Раскрой свой Кристалл Души</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1320; --panel:#141a2a; --ink:#eaf2ff; --muted:#9fb2cf; --accent:#6ea8ff;
  --ok:#3ddc97; --warn:#ffd166; --danger:#ff6b6b;
  --radius:18px; --gap:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--ink); background:radial-gradient(1200px 800px at 70% -10%,#1b2250,transparent), var(--bg);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
}
.wrap{max-width:980px; margin:auto; padding:24px}
header{text-align:center; margin:12px 0 18px}
h1{margin:0; font-weight:800; line-height:1.15; letter-spacing:.4px; font-size:clamp(28px,4.8vw,48px)}
h1 .glow{
  color:#ffeaa7; text-shadow:0 0 18px rgba(255,236,168,.65), 0 0 34px rgba(255,236,168,.5);
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius); padding:18px; box-shadow:var(--shadow);
}
.controls{display:grid; grid-template-columns:1fr auto; gap:var(--gap) var(--gap)}
.controls .row{display:grid; grid-template-columns:1fr 160px; gap:var(--gap)}
label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
select, input[type="date"], input[type="text"]{
  width:100%; height:48px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
  background:#0e1629; color:var(--ink); padding:0 14px; font-size:16px; outline:none;
}
.btn{
  appearance:none; border:0; border-radius:14px; cursor:pointer; height:48px; padding:0 20px;
  font-weight:700; letter-spacing:.2px; color:white;
  background:linear-gradient(180deg,#4f86ff,#3768f6); box-shadow:0 8px 20px rgba(80,140,255,.35);
  transition:.2s transform,.2s box-shadow,.2s filter;
}
.btn:hover{transform:translateY(-1px); filter:brightness(1.02)}
.btn.secondary{background:linear-gradient(180deg,#64748b,#556277); box-shadow:0 8px 20px rgba(84,96,120,.35)}
.btn:disabled{opacity:.55; cursor:not-allowed; filter:grayscale(.1)}
.center{display:flex; gap:var(--gap); align-items:end; justify-content:center; margin:16px 0 4px}

/* title under header (ВЯ) */
.vy{margin-top:8px; font-size:22px; font-weight:800; text-align:center}

/* grid */
.grid{margin-top:16px; display:grid; grid-template-columns:repeat(3,1fr); gap:14px; justify-items:center}
.grid .cell{
  width:min(180px,26vw); height:min(120px,17vw); min-width:110px; min-height:90px;
  display:flex; align-items:center; justify-content:center;
  border-radius:16px; color:#0e1220; font-weight:800; font-size:36px;
  box-shadow:0 8px 16px rgba(0,0,0,.28); border:1px solid rgba(0,0,0,.18)
}
.tag{position:absolute; inset:auto auto 10px 12px; font-size:11px; color:#00000099}
.cellWrap{position:relative}

/* colors for 1..12 */
.c1{background:#ff6b6b}.c2{background:#ff9f43}.c3{background:#ffd166}
.c4{background:#b6ff66}.c5{background:#1fa34a; color:#eafff0}
.c6{background:#86e1e9}.c7{background:#4f7cff; color:#eef4ff}
.c8{background:#c3e3ff}.c9{background:#b184ff}.c10{background:#d49efc}
.c11{background:#ff76b5}.c12{background:#f9c6d5}

/* accordion */
.accordion{margin-top:22px}
.acc-item{background:#11192b; border:1px solid rgba(255,255,255,.08); border-radius:16px; margin-bottom:14px; overflow:hidden}
.acc-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; cursor:pointer}
.acc-title{margin:0; font-size:18px; font-weight:800}
.acc-pill{font-weight:800; font-size:14px; padding:6px 10px; border-radius:999px; background:#0e1629; border:1px solid rgba(255,255,255,.12)}
.acc-body{display:none; padding:0 16px 16px; color:#e8f1ff}
.acc-body.show{display:block}
.acc-item.red .acc-title{color:#ff6b6b}
.acc-item.blue .acc-title{color:#6ea8ff}
.acc-item.green .acc-title{color:#3ddc97}

/* footer note */
.note{margin-top:8px; font-size:12px; color:var(--muted); text-align:center}

/* glow headline */
.kdglow{color:#ffeaa7; text-shadow:0 0 14px rgba(255,236,168,.6),0 0 26px rgba(255,236,168,.35), 0 0 40px rgba(255,236,168,.2)}
h1 span.small{font-weight:800}

/* tiny helper row */
.helper{display:flex; align-items:center; justify-content:center; gap:8px; margin:12px 0 0}
.helper input{transform:translateY(2px)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>
        <span data-i="reveal">Раскрой свой</span> <span class="kdglow" data-i="crystal">КРИСТАЛЛ ДУШИ</span>
      </h1>
    </header>

    <div class="card">
      <div class="controls">
        <div class="row">
          <div>
            <label data-i="birth">Дата рождения</label>
            <input id="dob" type="date" />
          </div>
          <div>
            <label data-i="lang">Язык</label>
            <select id="lang">
              <option value="auto">Auto</option>
              <option value="ru">Русский</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
        <div class="center">
          <button class="btn" id="calcBtn" data-i="calc">Рассчитать</button>
          <button class="btn secondary" id="pdfBtn" data-i="pdf">Скачать PDF</button>
        </div>
      </div>
    </div>

    <div id="vy" class="vy"></div>

    <!-- MATRIX -->
    <div id="grid" class="grid"></div>

    <!-- INSTRUCTIONS -->
    <div id="inst" class="accordion">
      <div class="card" style="margin-bottom:12px; background:#0f1629; border:1px solid rgba(255,255,255,.12)">
        <h2 style="margin:0; font-size:22px; font-weight:800; text-align:center" data-i="instTitle">Инструкция к кодам</h2>
      </div>

      <div class="acc-item red">
        <div class="acc-head">
          <h3 class="acc-title" data-i="t1">1) АКТИВАЦИЯ КРИСТАЛЛА ДУШИ</h3>
          <span id="pill1" class="acc-pill">N1 / N2 / N3</span>
        </div>
        <div class="acc-body" id="body1"></div>
      </div>

      <div class="acc-item blue">
        <div class="acc-head">
          <h3 class="acc-title" data-i="t2">2) ЗАПУСК ТОРСИОННОГО ПОЛЯ</h3>
          <span id="pill2" class="acc-pill">T1 / T2 / T3</span>
        </div>
        <div class="acc-body" id="body2"></div>
      </div>

      <div class="acc-item green">
        <div class="acc-head">
          <h3 class="acc-title" data-i="t3">3) ИНТЕГРАЦИЯ ТЕЛА СВЕТА</h3>
          <span id="pill3" class="acc-pill">C1 / C2 / C3</span>
        </div>
        <div class="acc-body" id="body3"></div>
      </div>
      <div class="note" data-i="note">PDF включает матрицу, уровень ВЯ и полные тексты трёх пунктов.</div>
    </div>
  </div>

  <!-- libs for PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5R0I4z8mJw7q7x0s4hQF9+g6sY+YJtP38tWkF3e0b7mQ8nQn3q6G7bE0Qw7yT3Hbnm0P6N2M9bK1QwH9Y1w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-NaWkZJdNl3g7W8fVgZ9s9bQ4wVY9y1o2r2Yc3M8r5Yw2+Fq6mT0g1VnQ8KzZ7o8L9X3h9oS7Jv1Q7G6ZKxJ2dg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
/* ========= i18n ========= */
const I18N = {
  ru: {
    reveal: "Раскрой свой",
    crystal: "КРИСТАЛЛ ДУШИ",
    birth: "Дата рождения",
    lang:"Язык",
    calc:"Рассчитать",
    pdf:"Скачать PDF",
    instTitle:"Инструкция к кодам",
    t1:"1) АКТИВАЦИЯ КРИСТАЛЛА ДУШИ",
    t2:"2) ЗАПУСК ТОРСИОННОГО ПОЛЯ",
    t3:"3) ИНТЕГРАЦИЯ ТЕЛА СВЕТА",
    vy:"Уровень Высшего Я",
    note:"PDF включает матрицу, уровень ВЯ и полные тексты трёх пунктов.",
    p1: (n1,n2,n3)=>`• «Вдыхаю Свет — Выдыхаю Любовь»: ладони в намасте, вдох из центра головы в Высшее сердце, выдох — раскрывая руки и излучая золотой свет. <b>N1 = ${n1}</b>.<br><br>
• «Вдыхаю Силу — Выдыхаю Волю»: вдох из солнечного сплетения в Тимус и выдох золотого света на раскрытых руках. <b>N2 = ${n2}</b>.<br><br>
• Простукивание точки Тимуса со звуком «аа». <b>N3 = ${n3}</b>.`,
    p2: (t1,t2,t3)=>`• Верхняя воронка (руки вверх, по часовой стрелке): вращение <b>T1 = ${t1}</b> раз — <i>вокруг своей оси</i>.<br><br>
• Нижняя воронка (руки вниз, против часовой стрелки): вращение <b>T2 = ${t2}</b> раз — <i>вокруг своей оси</i>.<br><br>
• Гармонизация: руки в намасте на груди и мягкие прыжки/перекат с пятки на носок <b>T3 = ${t3}</b> раз.`,
    p3: (c1,c2,c3)=>`• Одновременные круги руками вперёд — <b>C1 = ${c1}</b> раз.<br><br>
• Одновременные круги руками назад — <b>C2 = ${c2}</b> раз.<br><br>
• Фиксация: ладони в намасте на груди, мягкое надавливание ладонями друг на друга — <b>C3 = ${c3}</b> раз.`
  },
  en: {
    reveal:"Reveal your",
    crystal:"SOUL CRYSTAL",
    birth:"Date of birth",
    lang:"Language",
    calc:"Calculate",
    pdf:"Download PDF",
    instTitle:"Instructions for the codes",
    t1:"1) SOUL CRYSTAL ACTIVATION",
    t2:"2) TORSION FIELD LAUNCH",
    t3:"3) LIGHT BODY INTEGRATION",
    vy:"Higher Self Level",
    note:"PDF will include the grid, HS level, and all three instruction sections.",
    p1:(n1,n2,n3)=>`• “Inhale Light — Exhale Love”: palms in namaste, inhale from the head center to the Higher Heart, exhale opening the arms and radiating golden light. <b>N1 = ${n1}</b>.<br><br>
• “Inhale Power — Exhale Will”: inhale from the solar plexus to the thymus, exhale golden light with open arms. <b>N2 = ${n2}</b>.<br><br>
• Tapping the thymus point with the sound “aa”. <b>N3 = ${n3}</b>.`,
    p2:(t1,t2,t3)=>`• Upper vortex (arms up, clockwise): spin <b>T1 = ${t1}</b> times — <i>around your axis</i>.<br><br>
• Lower vortex (arms down, counter-clockwise): spin <b>T2 = ${t2}</b> times — <i>around your axis</i>.<br><br>
• Harmonization: palms in namaste on the chest and soft jumps/heel-to-toe rolls <b>T3 = ${t3}</b> times.`,
    p3:(c1,c2,c3)=>`• Simultaneous arm circles forward — <b>C1 = ${c1}</b> times.<br><br>
• Simultaneous arm circles backward — <b>C2 = ${c2}</b> times.<br><br>
• Fixation: palms in namaste on the chest, gentle pressing palms against each other — <b>C3 = ${c3}</b> times.`
  }
};

const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
const state = { lang:'ru', positions:null, vy: null };

function setLang(l){
  state.lang = l==='auto' ? (navigator.language||'en').startsWith('ru')?'ru':'en' : l;
  // apply UI text
  $$('[data-i]').forEach(el=>{
    const key = el.getAttribute('data-i');
    if (['reveal','crystal','birth','lang','calc','pdf','instTitle','t1','t2','t3','note'].includes(key)) {
      el.textContent = I18N[state.lang][key];
    }
  });
  renderAll();
}

/* ======= Rendering ======= */
function classFor(val){
  return 'c'+((val-1)%12+1);
}
function renderGrid(){
  const g = $('#grid'); g.innerHTML='';
  if(!state.positions){ return; }
  // order rows: P10,P11,P12 / P7,P8,P9 / P4,P5,P6 / P1,P2,P3
  const order = ['P10','P11','P12','P7','P8','P9','P4','P5','P6','P1','P2','P3'];
  order.forEach(k=>{
    const v = state.positions[k];
    const w = document.createElement('div');
    w.className='cellWrap';
    const t = document.createElement('div');
    t.className = `cell ${classFor(v)}`;
    t.textContent = v;
    const tag = document.createElement('div');
    tag.className='tag';
    tag.textContent=k.toUpperCase();
    w.appendChild(t); w.appendChild(tag);
    g.appendChild(w);
  });
}
function renderVY(){
  const el = $('#vy');
  if(state.vy==null){ el.textContent=''; return; }
  el.textContent = `${I18N[state.lang].vy}: ${state.vy}`;
}

/* ======= Calculations for N/T/C ======= */
const reduce12 = n => ((n-1)%12)+1;

function deriveCodes(pos){
  // N1 = P5, N2 = P8, N3 = reduce(P5+P8)
  const N1 = pos.P5, N2 = pos.P8, N3 = reduce12(pos.P5 + pos.P8);
  // T1 = reduce(P8+P10+P12) (духовная), T2 = reduce(P1+P3+P5) (материальная), T3 = reduce(T1+T2)
  const T1 = reduce12(pos.P8 + pos.P10 + pos.P12);
  const T2 = reduce12(pos.P1 + pos.P3 + pos.P5);
  const T3 = reduce12(T1 + T2);
  // C1 = reduce(P2+P4+P6), C2 = reduce(P7+P9+P11), C3 = reduce(C1+C2)
  const C1 = reduce12(pos.P2 + pos.P4 + pos.P6);
  const C2 = reduce12(pos.P7 + pos.P9 + pos.P11);
  const C3 = reduce12(C1 + C2);
  return {N1,N2,N3,T1,T2,T3,C1,C2,C3};
}

function renderInstructions(){
  if(!state.positions) return;
  const {N1,N2,N3,T1,T2,T3,C1,C2,C3} = deriveCodes(state.positions);
  $('#pill1').textContent = `N1 ${N1} • N2 ${N2} • N3 ${N3}`;
  $('#pill2').textContent = `T1 ${T1} • T2 ${T2} • T3 ${T3}`;
  $('#pill3').textContent = `C1 ${C1} • C2 ${C2} • C3 ${C3}`;

  $('#body1').innerHTML = I18N[state.lang].p1(N1,N2,N3);
  $('#body2').innerHTML = I18N[state.lang].p2(T1,T2,T3);
  $('#body3').innerHTML = I18N[state.lang].p3(C1,C2,C3);
}

function renderAll(){
  renderVY();
  renderGrid();
  renderInstructions();
}

/* ======= Accordion handlers ======= */
$$('.acc-head').forEach(h=>{
  h.addEventListener('click', ()=>{
    const body = h.parentElement.querySelector('.acc-body');
    body.classList.toggle('show');
  });
});

/* ======= Date default ======= */
(function initDate(){
  // If user previously typed dd.mm.yyyy in your older UI, keep using date input now.
  const d = $('#dob');
  // default to today
  const pad = n=>String(n).padStart(2,'0');
  const now = new Date();
  d.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
})();

/* ======= Hook to YOUR calculator =======
   Provide a function calcFromDate(dateStr) that returns:
   { vy: Number, positions: {P1..P12: Number} }
   with values 1..12 in your matrix mapping.
   If you already have it on the page — it will be used automatically.
*/
async function compute(dateStr){
  if(typeof window.calcFromDate === 'function'){
    // use existing proven algorithm
    return window.calcFromDate(dateStr);
  }else{
    alert("⚠️ Не найдена функция calcFromDate(dateStr).\nОставь свою рабочую функцию внизу файла или сохранённую ранее в проекте — я её вызову без изменений.");
    return null;
  }
}

/* ======= Actions ======= */
$('#lang').addEventListener('change', e=> setLang(e.target.value));
setLang('auto');

$('#calcBtn').addEventListener('click', async ()=>{
  const dateISO = $('#dob').value; // yyyy-mm-dd
  if(!dateISO){ return; }
  const [y,m,d] = dateISO.split('-');
  const dateStr = `${d}.${m}.${y}`; // твоему калькулятору удобно d.m.Y
  const out = await compute(dateStr);
  if(!out) return;
  state.positions = out.positions;
  state.vy = out.vy;
  renderAll();
});

/* ======= PDF ======= */
$('#pdfBtn').addEventListener('click', async ()=>{
  // делаем скрин страницы (wrap), сохраняем в PDF
  const area = document.querySelector('.wrap');
  const canvas = await html2canvas(area,{scale:2,backgroundColor:'#0e1320'});
  const img = canvas.toDataURL('image/png');
  const pdf = new jspdf.jsPDF('p','mm','a4');
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const imgW = pageW-16, imgH = imgW * (canvas.height/canvas.width);
  let y = 8;
  pdf.addImage(img,'PNG',8,y,imgW,imgH,'','FAST');
  pdf.save('SoulCrystal.pdf');
});

/* ======= YOUR proven algorithm goes here =======
   👉 ВСТАВЬ сюда свою уже корректную calcFromDate(dateStr)
   Пример заглушки (НЕ ИСПОЛЬЗУЙ на проде):
*/
// window.calcFromDate = function(dateStr){
//   // Заглушка только чтобы не падало при пустой функции
//   // Верни реальные данные из твоего алгоритма!
//   return {
//     vy: 52,
//     positions: {P1:4,P2:5,P3:7,P4:9,P5:11,P6:12,P7:2,P8:3,P9:5,P10:5,P11:7,P12:8}
//   };
// };
  </script>
</body>
</html>
